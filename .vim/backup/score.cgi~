#! /usr/local/bin/perl
use strict;
use warnings;

use POSIX 'strftime';
use Fcntl ':flock';

use CGI;
use CGI::Carp qw(fatalsToBrowser);


GETでのアクセスは認めない
if($ENV{'REQUEST_METHOD'} eq 'GET') {
    die "Unsupported request from 'GET'.\n";
}

変なクエリが送られてきてないか
read(STDIN, my $buf, $ENV{'CONTENT_LENGTH'});

my @query;
foreach (split(/&/, $buf)) {
    push(@query, (split(/=/, $_))[0]);  # クエリーのみ受け取る
}
foreach(@query) {
    $_ eq 'name' && next;
    $_ eq 'score' && next;

    die "不正なクエリ\n";   # 知らないクエリがあったら終了
}

# パラメーター取得
my $q = new CGI;
my $name = $q->param('name');     # 名前
my $score = $q->param('score');   # スコア

# スコアファイルオープン
unless( open(LOG, ">> ../log/score.log") ) {
    die "Sorry, Log File Open Error.\n$!\n";
} else {

    my $now = strftime("%Y/%m/%d %H:%M", localtime(time));    # 現在時刻取得
    flock(LOG, LOCK_EX);      # ファイルロック

    # 書き込み
    print LOG "$now&$name&$score";
    flock(LOG, LOCK_UN);    # ファイルロック解除
}
close(LOG);


print   $q->header,
        $q->start_html(-title => 'スコア登録完了'),
        $q->center($q->h2('登録完了')),
        $q->hr,
        "$name さんのスコアは無事登録されました。",
        $q->end_html;



